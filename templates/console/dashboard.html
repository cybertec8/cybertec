{% extends "console/base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
  .welcome-header {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .welcome-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    font-weight: 700;
    color: white;
  }

  .welcome-info h1 {
    font-size: 22px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .welcome-info p {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 20px;
    transition: all 0.2s ease;
  }

  .stat-card:hover {
    border-color: var(--border-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .stat-icon {
    width: 42px;
    height: 42px;
    border-radius: var(--radius-md);
    background: rgba(34, 197, 94, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--accent-green);
    margin-bottom: 14px;
  }

  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .progress-wrapper {
    margin-top: 12px;
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    background: var(--bg-primary);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 8px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
    border-radius: 10px;
    transition: width 0.3s ease;
  }

  .progress-text {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 16px;
  }

  .activity-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px;
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    margin-bottom: 10px;
  }

  .activity-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .activity-content {
    flex: 1;
  }

  .activity-text {
    font-size: 14px;
    color: var(--text-primary);
    margin-bottom: 2px;
  }

  .activity-time {
    font-size: 12px;
    color: var(--text-muted);
  }

  /* Activity Scrollable Area */
  #activity-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 8px;
    /* Space for scrollbar */
    scrollbar-width: thin;
    /* Firefox */
    scrollbar-color: var(--border-color) transparent;
    /* Firefox */
  }

  /* Custom Webkit Scrollbar */
  #activity-list::-webkit-scrollbar {
    width: 6px;
  }

  #activity-list::-webkit-scrollbar-track {
    background: transparent;
  }

  #activity-list::-webkit-scrollbar-thumb {
    background: #1f2933;
    border-radius: 10px;
  }

  #activity-list::-webkit-scrollbar-thumb:hover {
    background: #374151;
  }

  .challenge-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 18px;
    transition: all 0.2s ease;
  }

  .challenge-card:hover {
    border-color: var(--border-hover);
    transform: translateY(-2px);
  }

  .challenge-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .challenge-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .challenge-category {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .challenge-points {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-green);
  }

  .challenge-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
  }

  .announcement-item {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 12px;
  }

  .announcement-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .announcement-text {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
</style>
{% endblock %}

{% block content %}

<!-- Welcome Header -->
<div class="welcome-header">
  <div class="welcome-avatar" id="welcome-avatar">
    {{ current_user.username[0]|upper }}
  </div>
  <div class="welcome-info">
    <h1>Welcome back, <span id="welcome-username">{{ current_user.username }}</span>! ðŸ‘‹</h1>
    <p>Player ID #<span id="welcome-player-id">{{ current_user.id }}</span> â€¢ Ready for your next challenge?</p>
  </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-4 mb-lg">

  <div class="stat-card">
    <div class="stat-icon">
      <i class='bx bx-trophy'></i>
    </div>
    <div class="stat-value" id="stat-challenges">0</div>
    <div class="stat-label">Active Challenges</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue);">
      <i class='bx bx-group'></i>
    </div>
    <div class="stat-value" id="stat-teams">0</div>
    <div class="stat-label">My Teams</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--accent-yellow);">
      <i class='bx bx-medal'></i>
    </div>
    <div class="stat-value" id="stat-rank">Beginner</div>
    <div class="stat-label">Current Rank</div>
    <div class="progress-wrapper">
      <div class="progress-bar">
        <div class="progress-fill" id="stat-xp-progress" style="width: 0%;"></div>
      </div>
      <div class="progress-text" id="stat-xp-text">0 / 1000 XP to Intermediate</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
      <i class='bx bx-star'></i>
    </div>
    <div class="stat-value" id="stat-total-xp">0</div>
    <div class="stat-label">Total XP Points</div>
  </div>

</div>

<!-- Main Content Grid -->
<div class="grid grid-3 gap-lg">

  <!-- Recent Activity -->
  <div style="grid-column: span 2;">
    <div class="card">
      <h3 class="section-title">Recent Activity</h3>
      <div id="activity-list">
        <div class="text-center py-4 text-muted">Loading activity...</div>
      </div>
    </div>
  </div>

  <!-- Upcoming Events -->
  <div>
    <div class="card">
      <h3 class="section-title">Upcoming Events</h3>

      <div class="announcement-item">
        <div class="announcement-title">Weekly CTF Challenge</div>
        <div class="announcement-text">Join our weekly competition starting Friday at 6 PM</div>
      </div>

      <div class="announcement-item">
        <div class="announcement-title">New Challenges Added</div>
        <div class="announcement-text">Check checking out 5 new cryptography challenges in the lobby</div>
      </div>

      <a href="/dashboard/events" class="btn btn-primary" style="width: 100%; margin-top: 12px;">
        <i class='bx bx-right-arrow-alt'></i>
        View All Events
      </a>
    </div>
  </div>

</div>

<!-- Recommended Challenges -->
<div class="mt-lg">
  <h3 class="section-title">Recommended Challenges for You</h3>

  <div class="grid grid-3 gap-md">

    <div class="challenge-card">
      <div class="challenge-header">
        <div>
          <div class="challenge-title">Web Security Basics</div>
          <div class="challenge-category">Web Security</div>
        </div>
        <div class="challenge-points">100 pts</div>
      </div>
      <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
        Learn the fundamentals of web application security and common vulnerabilities.
      </p>
      <div class="challenge-footer">
        <span class="badge badge-success">Easy</span>
        <a href="/challenges" class="btn btn-sm btn-primary">Start Challenge</a>
      </div>
    </div>

    <div class="challenge-card">
      <div class="challenge-header">
        <div>
          <div class="challenge-title">Crypto 101</div>
          <div class="challenge-category">Cryptography</div>
        </div>
        <div class="challenge-points">150 pts</div>
      </div>
      <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
        Crack basic encryption algorithms and understand cryptographic principles.
      </p>
      <div class="challenge-footer">
        <span class="badge badge-warning">Medium</span>
        <a href="/challenges" class="btn btn-sm btn-primary">Start Challenge</a>
      </div>
    </div>

    <div class="challenge-card">
      <div class="challenge-header">
        <div>
          <div class="challenge-title">Network Analysis</div>
          <div class="challenge-category">Networking</div>
        </div>
        <div class="challenge-points">120 pts</div>
      </div>
      <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
        Analyze network traffic and identify security issues in packet captures.
      </p>
      <div class="challenge-footer">
        <span class="badge badge-success">Easy</span>
        <a href="/challenges" class="btn btn-sm btn-primary">Start Challenge</a>
      </div>
    </div>

  </div>
</div>

<script>
  async function updateDashboard() {
    try {
      // Update Stats
      const statsRes = await fetch('/api/dashboard/stats');
      const stats = await statsRes.json();

      document.getElementById('stat-challenges').innerText = stats.active_challenges;
      document.getElementById('stat-teams').innerText = stats.teams_count;
      document.getElementById('stat-rank').innerText = stats.rank;
      document.getElementById('stat-total-xp').innerText = stats.xp;

      const progressFill = document.getElementById('stat-xp-progress');
      progressFill.style.width = stats.progress_percent + '%';

      const nextLevel = stats.rank === 'Advanced' ? 'Max' : 'Next Level';
      document.getElementById('stat-xp-text').innerText = `${stats.xp} / ${stats.next_xp_threshold} XP to ${nextLevel}`;

      // Update Activity
      const activityRes = await fetch('/api/dashboard/activity');
      const activityData = await activityRes.json();
      const activityList = document.getElementById('activity-list');

      if (activityData.activities.length === 0) {
        activityList.innerHTML = '<div class="text-center py-4 text-muted">No recent activity</div>';
      } else {
        activityList.innerHTML = '';
        activityData.activities.forEach(act => {
          let iconColor = 'var(--accent-green)';
          let iconClass = 'bx bx-check-circle';

          if (act.type === 'team_join') {
            iconColor = 'var(--accent-blue)';
            iconClass = 'bx bx-group';
          } else if (act.type === 'achievement') {
            iconColor = '#a855f7';
            iconClass = 'bx bx-medal';
          }

          const item = `
                        <div class="activity-item animate-in">
                            <div class="activity-icon" style="color: ${iconColor};">
                                <i class='${iconClass}'></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${act.action}</div>
                                <div class="activity-time">${act.time_ago}</div>
                            </div>
                        </div>
                    `;
          activityList.innerHTML += item;
        });
      }

    } catch (err) {
      console.error('Error updating dashboard:', err);
    }
  }

  // Initial load
  updateDashboard();

  // Poll every 10 seconds for real-time feel
  setInterval(updateDashboard, 10000);
</script>

<style>
  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-in {
    animation: fadeInSlide 0.4s ease-out forwards;
  }
</style>

{% endblock %}